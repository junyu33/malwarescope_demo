#!/bin/sh
# host_get_stacktrace.sh <input> <output>
echo "running host_get_stacktrace.sh $1 $2"
echo "[STEP 1]: and reboot"
#ssh -i ~/.ssh/id_host Archive@192.168.56.3 "shutdown -f -r -t 0"

VBoxManage controlvm "XP" poweroff
VBoxManage snapshot "XP" restore "turn off shared folders"

echo "[STEP 2]: wait for XP starts"
VBoxManage startvm "XP" --type headless

#while true; do
#  # Ping the VM to check if it is reachable and display message based on the result
#  if ping -c 1 192.168.56.3 &> /dev/null; then
#    echo "Windows XP VM is running and reachable on the network."
#    break  # Exit the loop if VM is reachable
#  else
#    echo "Windows XP VM is not running or not reachable on the network. Trying again in 5 seconds..."
#    sleep 5  # Wait for 5 seconds before trying again
#  fi
#done

echo "[STEP 3]: then copy the malware to the remote host"
scp -i ~/.ssh/id_host $1 Archive@192.168.56.3:/tmp/VirusShare_0aa06ef1402d832b789698f0b53f54a1.exe
echo "[STEP 4]: delete log files"
ssh -i ~/.ssh/id_host Archive@192.168.56.3 "cd /cygdrive/c && rm *.txt *.log"
echo "[STEP 5]: change debug param in conf"
ssh -i ~/.ssh/id_host Archive@192.168.56.3 "cd /cygdrive/c/tmp3wnweh && ./update-debug.sh 0"
echo "[STEP 6]: execute analyzer.py"
timeout 15s ssh -i ~/.ssh/id_host Archive@192.168.56.3 "cd /cygdrive/c/tmp3wnweh && export TEMP=/tmp && cmd /C 'python analyzer.py'"
echo "[STEP 7]: get stacktrace"
rsync -avz --timeout=10 -e "ssh -i ~/.ssh/id_host" Archive@192.168.56.3:/cygdrive/c/stacktrace-debug.txt $2

